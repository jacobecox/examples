kind: workload
name: {{ .Values.api.name }}
gvc: {{ .Values.cpln.gvc }}
spec:
  type: standard
  containers:
    - name: {{ .Values.api.name }}
      image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
      cpu: '{{ .Values.api.cpu }}'
      memory: {{ .Values.api.memory }}
      ports:
        - protocol: http
          number: {{ .Values.api.port }}
      env:
        - name: MODE
          value: "api"
        - name: PORT
          value: "{{ .Values.api.port }}"
        - name: LOG_LEVEL
          value: {{ .Values.logLevel | quote }}
        # Redis Sentinel configuration
        - name: REDIS_SENTINEL_ADDR
          value: {{ .Values.redis.sentinelAddr | quote }}
        - name: REDIS_MASTER_NAME
          value: {{ .Values.redis.masterName | quote }}
        - name: REDIS_PASSWORD
          value: "cpln://secret/{{ .Values.secrets.name }}.redis-password"
        - name: REDIS_SENTINEL_PASSWORD
          value: "cpln://secret/{{ .Values.secrets.name }}.redis-sentinel-password"
        # Task configuration
        - name: TASK_TIMEOUT_SEC
          value: "{{ .Values.task.timeoutSec }}"
        - name: MAX_RETRY
          value: "{{ .Values.task.maxRetry }}"
        # Admin API key
        {{- if .Values.adminApiKey }}
        - name: ADMIN_API_KEY
          value: "cpln://secret/{{ .Values.secrets.name }}.admin-api-key"
        {{- end }}
        # OpenTelemetry
        {{- if .Values.otel.enabled }}
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.otel.endpoint | quote }}
        {{- end }}
      livenessProbe:
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
        httpGet:
          path: /health/live
          port: {{ .Values.api.port }}
          scheme: HTTP
      readinessProbe:
        initialDelaySeconds: 5
        periodSeconds: 5
        timeoutSeconds: 3
        successThreshold: 1
        failureThreshold: 3
        httpGet:
          path: /health/ready
          port: {{ .Values.api.port }}
          scheme: HTTP
  defaultOptions:
    autoscaling:
      minScale: '{{ .Values.api.replicas }}'
      maxScale: '{{ .Values.api.replicas }}'
      metric: disabled
    capacityAI: false
    timeoutSeconds: 60
    suspend: false
{{- if .Values.firewall }}
  firewallConfig:
    {{- if or (hasKey .Values.firewall "external_inboundAllowCIDR") (hasKey .Values.firewall "external_outboundAllowCIDR") }}
    external:
      inboundAllowCIDR: {{- if .Values.firewall.external_inboundAllowCIDR }}{{ .Values.firewall.external_inboundAllowCIDR | splitList "," | toYaml | nindent 8 }}{{- else }} []{{- end }}
      outboundAllowCIDR: {{- if .Values.firewall.external_outboundAllowCIDR }}{{ .Values.firewall.external_outboundAllowCIDR | splitList "," | toYaml | nindent 8 }}{{- else }} []{{- end }}
    {{- end }}
    {{- if hasKey .Values.firewall "internal_inboundAllowType" }}
    internal:
      inboundAllowType: {{ default "[]" .Values.firewall.internal_inboundAllowType }}
    {{- end }}
{{- end }}

