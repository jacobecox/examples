kind: workload
name: {{ .Values.worker.name }}
gvc: {{ .Values.cpln.gvc }}
spec:
  type: standard
  containers:
    - name: {{ .Values.worker.name }}
      image: {{ .Values.image.repository }}:{{ .Values.image.tag }}
      cpu: '{{ .Values.worker.cpu }}'
      memory: {{ .Values.worker.memory }}
      ports:
        - protocol: http
          number: 8080
      env:
        - name: MODE
          value: "worker"
        - name: PORT
          value: "8080"
        - name: LOG_LEVEL
          value: {{ .Values.logLevel | quote }}
        - name: WORKER_CONCURRENCY
          value: "{{ .Values.worker.concurrency }}"
        # Redis Sentinel configuration
        - name: REDIS_SENTINEL_ADDR
          value: {{ .Values.redis.sentinelAddr | quote }}
        - name: REDIS_MASTER_NAME
          value: {{ .Values.redis.masterName | quote }}
        - name: REDIS_PASSWORD
          value: "cpln://secret/{{ .Values.secrets.name }}.redis-password"
        - name: REDIS_SENTINEL_PASSWORD
          value: "cpln://secret/{{ .Values.secrets.name }}.redis-sentinel-password"
        # Task configuration
        - name: TASK_TIMEOUT_SEC
          value: "{{ .Values.task.timeoutSec }}"
        - name: MAX_RETRY
          value: "{{ .Values.task.maxRetry }}"
        # Circuit breaker configuration
        - name: CB_MAX_REQUESTS
          value: "{{ .Values.circuitBreaker.maxRequests }}"
        - name: CB_INTERVAL_SEC
          value: "{{ .Values.circuitBreaker.intervalSec }}"
        - name: CB_TIMEOUT_SEC
          value: "{{ .Values.circuitBreaker.timeoutSec }}"
        - name: CB_FAILURE_THRESHOLD
          value: "{{ .Values.circuitBreaker.failureThreshold }}"
        # OpenTelemetry
        {{- if .Values.otel.enabled }}
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.otel.endpoint | quote }}
        {{- end }}
      livenessProbe:
        initialDelaySeconds: 10
        periodSeconds: 10
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
        httpGet:
          path: /health/live
          port: 8080
          scheme: HTTP
      readinessProbe:
        initialDelaySeconds: 5
        periodSeconds: 5
        timeoutSeconds: 3
        successThreshold: 1
        failureThreshold: 3
        httpGet:
          path: /health/ready
          port: 8080
          scheme: HTTP
  defaultOptions:
    autoscaling:
      minScale: '{{ .Values.worker.replicas }}'
      maxScale: '{{ .Values.worker.replicas }}'
      metric: disabled
    capacityAI: false
    timeoutSeconds: 60
    suspend: false
{{- if .Values.firewall }}
  firewallConfig:
    {{- if or (hasKey .Values.firewall "external_inboundAllowCIDR") (hasKey .Values.firewall "external_outboundAllowCIDR") }}
    external:
      inboundAllowCIDR: {{- if .Values.firewall.external_inboundAllowCIDR }}{{ .Values.firewall.external_inboundAllowCIDR | splitList "," | toYaml | nindent 8 }}{{- else }} []{{- end }}
      outboundAllowCIDR: {{- if .Values.firewall.external_outboundAllowCIDR }}{{ .Values.firewall.external_outboundAllowCIDR | splitList "," | toYaml | nindent 8 }}{{- else }} []{{- end }}
    {{- end }}
    {{- if hasKey .Values.firewall "internal_inboundAllowType" }}
    internal:
      inboundAllowType: {{ default "[]" .Values.firewall.internal_inboundAllowType }}
    {{- end }}
{{- end }}

